
<html> 
<head> 
<title>Java Source Code Warehouse :: Example ::  StrictSSLProtocolSocketFactory.java</title> 
<link rel="StyleSheet" href="/scw/scw.css" type="text/css" media="screen" /> 
</head> 
<body> 
<!-- ValueClick Media POP-UNDER CODE v1.8 for devdaily.com (12 hour) --> 
<script language="javascript"><!--                                 
var dc=document; var date_ob=new Date();
dc.cookie='h2=o; path=/;';var bust=date_ob.getSeconds();
if(dc.cookie.indexOf('e=llo') <= 0 && dc.cookie.indexOf('2=o') > 0){
dc.write('<scr'+'ipt language="javascript" src="http://media.fastclick.net');
dc.write('/w/pop.cgi?sid=7536&m=2&tp=2&v=1.8&c='+bust+'"></scr'+'ipt>');
date_ob.setTime(date_ob.getTime()+43200000);
dc.cookie='he=llo; path=/; expires='+ date_ob.toGMTString();} // -->
</script>                                                          
<!-- ValueClick Media POP-UNDER CODE v1.8 for devdaily.com --> 
 
<table width="100%" bgcolor="#c0c0c0" cellpadding="2" cellspacing="0"> 
<tr> 
<td> 
 
<table border="0" cellpadding="4" width="100%" bgcolor="#ffffff"> 
 <tr> 
  <td valign="top" align="left"><a
      href="/">devdaily home</a>&nbsp;|&nbsp;<a
      href="/career/">career</a>&nbsp;|&nbsp;<a
      href="/drupal/">drupal</a>&nbsp;|&nbsp;<a
      href="/java/">java</a>&nbsp;|&nbsp;<a
      href="/mac/">mac</a>&nbsp;|&nbsp;<a
      href="/mysql/">mysql</a>&nbsp;|&nbsp;<a
      href="/perl/">perl</a>&nbsp;|&nbsp;<a
      href="/php/">php</a>&nbsp;|&nbsp;<a
      href="/uml/">uml</a>&nbsp;|&nbsp;<a
      href="/unix/">unix</a> 
  </td> 
  <td valign="top" align="right"> 
<!-- SiteSearch Google --> 
<form method="get" action="http://www.google.com/custom" target="_top"> 
<table border="0" bgcolor="#ffffff"> 
<tr> 
<td nowrap="nowrap"> 
<input type="hidden" name="domains" value="devdaily.com"></input> 
<label for="sbi" style="display: none">Enter your search terms</label> 
<input type="text" name="q" size="25" maxlength="255" value="" id="sbi"></input> 
<label for="sbb" style="display: none">Submit search form</label> 
<input type="submit" name="sa" value="Google Search" id="sbb"></input> 
<input type="radio" name="sitesearch" value="" checked id="ss0"></input> 
<label for="ss0" title="Search the Web"><font size="-1" color="#000000">Web</font></label> 
<input type="radio" name="sitesearch" value="devdaily.com" id="ss1"></input> 
<label for="ss1" title="Search devdaily.com"><font size="-1" color="#000000">devdaily.com</font></label> 
</td> 
</tr> 
</table> 
<input type="hidden" name="hl" value="en"></input> 
</form> 
<!-- SiteSearch Google --> 
  </td> 
</tr> 
</table> 
 
</td> 
</tr> 
</table> 
 
<!-- header ad --> 
 
<div id="scw-header"> 
 <script type="text/javascript"><!--
google_ad_client = "pub-5530641073697401";
google_ad_width = 728;
google_ad_height = 90;
google_ad_format = "728x90_as";
google_ad_channel ="";
google_color_border = "FFFFFF";
google_color_bg = "FFFFFF";
google_color_link = "304878";
google_color_url = "304878";
google_color_text = "000000";
//--></script> 
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js"> 
</script> 
 
</div> 
 
 
 
 
 
<div> 
<table width="100%"> 
<tr> 
<td align="left" valign="top"> 
<div align="left" id="leftcol"> 
<div align="left"> 
<script type="text/javascript"><!--
google_ad_client = "pub-5530641073697401";
google_alternate_ad_url = "http://www.devdaily.com/global/fastClick-sky.html";
google_ad_width = 120;
google_ad_height = 600;
google_ad_format = "120x600_as";
google_ad_channel ="";
google_color_border = "B4D0DC";
google_color_bg = "ECF8FF";
google_color_link = "0000CC";
google_color_url = "008000";
google_color_text = "6F6F6F";
//--></script> 
<script type="text/javascript"
  src="http://pagead2.googlesyndication.com/pagead/show_ads.js"> 
</script> 
</div> 
 
<p>&nbsp;</p> 
 
</div> 
 
 
</td> 
<td align="left" valign="top"> 
<div> 
 
<h3>What this is</h3> 
<blockquote> 
  <p>This file is included in the <a href="http://devdaily.com">DevDaily.com</a> 
  &quot;<a href="/java/jwarehouse">Java Source Code
  Warehouse</a>&quot; project. The intent of this project is to help you &quot;<i>Learn
  Java by Example</i>&quot; <sup><i>TM</i></sup>. </p> 
</blockquote> 
 
<h3>Other links</h3> 
<ul> 
  <li><a href="/java/jwarehouse"><img src="/images/scw/find.png" border="0">&nbsp;The search page</a></li> 
  <li><a href="index.shtml"><img src="/images/scw/folder.png" border="0">&nbsp;Other source code files at this package level</a></li> 
  <li><a href="/java/jwarehouse/about.shtml"><img src="/images/scw/information.png" border="0">&nbsp;Click here to learn more about this project</a></li> 
</ul> 
<h3>The source code</h3> 
 
</div> 
<pre> 
/*
 * $Header: /home/cvs/jakarta-commons/httpclient/src/contrib/org/apache/commons/httpclient/contrib/ssl/StrictSSLProtocolSocketFactory.java,v 1.1.2.2 2004/06/09 21:07:41 olegk Exp $
 * $Revision: 1.1.2.2 $
 * $Date: 2004/06/09 21:07:41 $
 *
 * ====================================================================
 *
 *  Copyright 1999-2004 The Apache Software Foundation
 *
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 * ====================================================================
 *
 * This software consists of voluntary contributions made by many
 * individuals on behalf of the Apache Software Foundation.  For more
 * information on the Apache Software Foundation, please see
 *
 * [Additional notices, if required by prior licensing conditions]
 *
 * Alternatively, the contents of this file may be used under the
 * terms of the GNU Lesser General Public License Version 2 or later
 * (the "LGPL"), in which case the provisions of the LGPL are 
 * applicable instead of those above.  See terms of LGPL at
 * If you wish to allow use of your version of this file only under 
 * the terms of the LGPL and not to allow others to use your version
 * of this file under the Apache Software License, indicate your 
 * decision by deleting the provisions above and replace them with 
 * the notice and other provisions required by the LGPL.  If you do 
 * not delete the provisions above, a recipient may use your version 
 * of this file under either the Apache Software License or the LGPL.
 */
 
package org.apache.commons.httpclient.contrib.ssl;
 
import java.io.IOException;
import java.net.InetAddress;
import java.net.Socket;
import java.net.UnknownHostException;
 
import javax.net.ssl.SSLPeerUnverifiedException;
import javax.net.ssl.SSLSession;
import javax.net.ssl.SSLSocket;
import javax.net.ssl.SSLSocketFactory;
import javax.security.cert.X509Certificate;
 
import org.apache.commons.httpclient.protocol.SecureProtocolSocketFactory;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
 
 
/**
 * A <code>SecureProtocolSocketFactory</code> that uses JSSE to create
 * SSL sockets.  It will also support host name verification to help preventing
 * man-in-the-middle attacks.  Host name verification is turned <b>on</b> by
 * default but one will be able to turn it off, which might be a useful feature
 * during development.  Host name verification will make sure the SSL sessions
 * server host name matches with the the host name returned in the 
 * server certificates "Common Name" field of the "SubjectDN" entry.
 *
 * @author <a href="mailto:hauer@psicode.com">Sebastian Hauer</a> 
 * <p> 
 * DISCLAIMER: HttpClient developers DO NOT actively support this component.
 * The component is provided as a reference material, which may be inappropriate
 * for use without additional customization.
 * </p> 
 */
public class StrictSSLProtocolSocketFactory 
    implements SecureProtocolSocketFactory {
 
    /** Log object for this class. */
    private static final Log LOG = LogFactory.getLog(StrictSSLProtocolSocketFactory.class);
 
    /** Host name verify flag. */
    private boolean verifyHostname = true;
 
 
    /**
     * Constructor for StrictSSLProtocolSocketFactory.
     * @param verifyHostname  The host name verification flag. If set to 
     * <code>true</code> the SSL sessions server host name will be compared
     * to the host name returned in the server certificates "Common Name" 
     * field of the "SubjectDN" entry.  If these names do not match a
     * Exception is thrown to indicate this.  Enabling host name verification 
     * will help to prevent from man-in-the-middle attacks.  If set to 
     * <code>false</code> host name verification is turned off.
     * 
     * Code sample:
     *  
     *     <blockquote> 
     *     Protocol stricthttps = new Protocol( 
     *         "https", new StrictSSLProtocolSocketFactory(true), 443);
     *
     *     HttpClient client = new HttpClient();
     *     client.getHostConfiguration().setHost("localhost", 443, stricthttps);
     *     </blockquote> 
     *
     */
    public StrictSSLProtocolSocketFactory(boolean verifyHostname) {
        super();
        this.verifyHostname = verifyHostname;
    }
 
    /**
     * Constructor for StrictSSLProtocolSocketFactory.
     * Host name verification will be enabled by default.
     */
    public StrictSSLProtocolSocketFactory() {
        super();
    }
 
    /**
     * Set the host name verification flag.
     *
     * @param verifyHostname  The host name verification flag. If set to 
     * <code>true</code> the SSL sessions server host name will be compared
     * to the host name returned in the server certificates "Common Name" 
     * field of the "SubjectDN" entry.  If these names do not match a
     * Exception is thrown to indicate this.  Enabling host name verification 
     * will help to prevent from man-in-the-middle attacks.  If set to 
     * <code>false</code> host name verification is turned off.
     */
    public void setHostnameVerification(boolean verifyHostname) {
        this.verifyHostname = verifyHostname;
    }
 
    /**
     * Gets the status of the host name verification flag.
     *
     * @return  Host name verification flag.  Either <code>true</code> if host
     * name verification is turned on, or <code>false</code> if host name
     * verification is turned off.
     */
    public boolean getHostnameVerification() {
        return verifyHostname;
    }
 
    
    /**
     * @see SecureProtocolSocketFactory#createSocket(java.lang.String,int,java.net.InetAddress,int)
     */
    public Socket createSocket(String host, int port, 
                               InetAddress clientHost, int clientPort)
        throws IOException, UnknownHostException {
        SSLSocketFactory sf = (SSLSocketFactory) SSLSocketFactory.getDefault();
        SSLSocket sslSocket = (SSLSocket) sf.createSocket(host, port, 
                                                          clientHost, 
                                                          clientPort);
        verifyHostname(sslSocket);
 
        return sslSocket;
    }
 
    /**
     * @see SecureProtocolSocketFactory#createSocket(java.lang.String,int)
     */
    public Socket createSocket(String host, int port)
        throws IOException, UnknownHostException {
        SSLSocketFactory sf = (SSLSocketFactory) SSLSocketFactory.getDefault();
        SSLSocket sslSocket = (SSLSocket) sf.createSocket(host, port);
        verifyHostname(sslSocket);
 
        return sslSocket;
    }
 
    /**
     * @see SecureProtocolSocketFactory#createSocket(java.net.Socket,java.lang.String,int,boolean)
     */
    public Socket createSocket(Socket socket, String host, int port, 
                               boolean autoClose)
        throws IOException, UnknownHostException {
        SSLSocketFactory sf = (SSLSocketFactory) SSLSocketFactory.getDefault();
        SSLSocket sslSocket = (SSLSocket) sf.createSocket(socket, host, 
                                                          port, autoClose);
        verifyHostname(sslSocket);
 
        return sslSocket;
    }
 
 
    /**
     * Describe <code>verifyHostname</code> method here.
     *
     * @param socket a <code>SSLSocket</code> value
     * @exception SSLPeerUnverifiedException  If there are problems obtaining
     * the server certificates from the SSL session, or the server host name 
     * does not match with the "Common Name" in the server certificates 
     * SubjectDN.
     * @exception UnknownHostException  If we are not able to resolve
     * the SSL sessions returned server host name. 
     */
    private void verifyHostname(SSLSocket socket) 
        throws SSLPeerUnverifiedException, UnknownHostException {
        if (! verifyHostname) 
            return;
 
        SSLSession session = socket.getSession();
        String hostname = session.getPeerHost();
        try {
            InetAddress addr = InetAddress.getByName(hostname);
        } catch (UnknownHostException uhe) {
            throw new UnknownHostException("Could not resolve SSL sessions "
                                           + "server hostname: " + hostname);
        }
        
        X509Certificate[] certs = session.getPeerCertificateChain();
        if (certs == null || certs.length == 0) 
            throw new SSLPeerUnverifiedException("No server certificates found!");
        
        //get the servers DN in its string representation
        String dn = certs[0].getSubjectDN().getName();
 
        //might be useful to print out all certificates we receive from the
        //server, in case one has to debug a problem with the installed certs.
        if (LOG.isDebugEnabled()) {
            LOG.debug("Server certificate chain:");
            for (int i = 0; i < certs.length; i++) {
                LOG.debug("X509Certificate[" + i + "]=" + certs[i]);
            }
        }
        //get the common name from the first cert
        String cn = getCN(dn);
        if (hostname.equalsIgnoreCase(cn)) {
            if (LOG.isDebugEnabled()) {
                LOG.debug("Target hostname valid: " + cn);
            }
        } else {
            throw new SSLPeerUnverifiedException(
                "HTTPS hostname invalid: expected '" + hostname + "', received '" + cn + "'");
        }
    }
 
 
    /**
     * Parses a X.500 distinguished name for the value of the 
     * "Common Name" field.
     * This is done a bit sloppy right now and should probably be done a bit
     * more according to <code>RFC 2253</code>.
     *
     * @param dn  a X.500 distinguished name.
     * @return the value of the "Common Name" field.
     */
    private String getCN(String dn) {
        int i = 0;
        i = dn.indexOf("CN=");
        if (i == -1) {
            return null;
        }
        //get the remaining DN without CN=
        dn = dn.substring(i + 3);  
        // System.out.println("dn=" + dn);
        char[] dncs = dn.toCharArray();
        for (i = 0; i < dncs.length; i++) {
            if (dncs[i] == ','  && i > 0 && dncs[i - 1] != '\\') {
                break;
            }
        }
        return dn.substring(0, i);
    }
}
</pre> 
</td> 
</tr> 
</table> 
</div> 
<div id="scw-footer">



<div align="center"> 
 
<a href="http://www.kqzyfj.com/click-3726774-10812821" target="_top"> 
<img src="http://www.ftjcfx.com/image-3726774-10812821" width="300" height="250" alt="" border="0"/></a> 
 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
 
<a href="http://www.anrdoezrs.net/click-3726774-10817046" target="_top"> 
<img src="http://www.tqlkg.com/image-3726774-10817046" width="300" height="250" alt="" border="0"/></a> 
</div> 




</div>



<div id="whats_new"> 
<h2>new blog posts</h2> 
<div id="whats_new_list"> 
<ul> 
<li><a class="whats_new_link" href="/uml/uml-use-cases-actors-list-actors-diagram">UML Use Cases and a &quot;List of Actors&quot; diagram</a></li> 
<li><a class="whats_new_link" href="/apple/when-ripping-dvd-movie-digital-video-file-makes-sense">When ripping a DVD to a digital movie file makes sense</a></li> 
<br/> 
<li><a class="whats_new_link" href="/ruby/ruby-stdout-stderr-output-files">Ruby stdout and stderr</a></li> 
<li><a class="whats_new_link" href="/business/revenue-per-employee-computer-services-industry">Revenue per Employee in the computer industry</a></li> 
<li><a class="whats_new_link" href="/apple/apple-revenue-per-employee-financial">Apple revenue per employee (amazing)</a></li> 
</ul> 
</div> 
 
<br/> 
</div> 




<br/>

<p>&nbsp;</p>

<br/>



<div align="center">

<p>

<a href="/gadgets/geek-gift-ideas-under-10-2009-gifts-geeks">geek gifts under $10</a> - 

<a href="/gadgets/geek-gift-ideas-under-20-2009-gifts-geeks">geek gifts under $20</a> - 

<a href="/gadgets/geek-gifts-ideas-under-50-holiday-2009">geek gifts under $50</a> - 

<a href="/gadgets/geek-gift-ideas-under-100-holiday-2009">geek gifts under $100</a>

<br/>

<a href="/hide-desktop-and-desktop-icons" title="A 99-cent app to hide your desktop icons">hide your desktop and desktop icons</a>

</p>

</div>



<p align="center"><font color="#000000" size="1"

face="Verdana,Arial">Copyright 1998-2010 Alvin Alexander<br/>

All Rights Reserved.

<br>&nbsp;<br>devdaily.com is based in louisville, kentucky.</font></p>



<p>&nbsp;</p>

<p>&nbsp;</p>

<p>&nbsp;</p>

<p>&nbsp;</p>



<!--google analytics-->

<script type="text/javascript">

var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");

document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));

</script>

<script type="text/javascript">

try {

var pageTracker = _gat._getTracker("UA-10480700-1");

pageTracker._trackPageview();

} catch(err) {}</script>



 
</body> 